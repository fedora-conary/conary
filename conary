#!/usr/bin/python2

import os
import sys
import util
import importrpm
import string
import package
import update
import commit
import srscfg

cfg = srscfg.SrsConfiguration()

fileDB = cfg.dbpath + "/files"
pkgDB = cfg.dbpath + "/pkgs"
util.mkdirChain(fileDB, pkgDB)

def usage():
    print "usage: srs import <file.rpm>"
    print "       srs pkglist <pkg>"
    print "       srs update  <pkg>"
    print "       srs commit  <pkg> <version> <root> <filelist>"
    sys.exit(0)

def displayPkgs(dbpath, packageList):
    for pkgName in packageList:
	pkgSet = package.PackageSet(dbpath, pkgName)
	l = pkgSet.versionList()
	for version in l:
	    print "%-24s %s" % (pkgName, version)

if (len(sys.argv) < 2):
    usage()
elif (sys.argv[1] == "import"):
    for file in sys.argv[2:]:
	importrpm.doImport(cfg.dbpath, file)
elif (sys.argv[1] == "pkglist"):
    if (len(sys.argv) == 2):
	displayPkgs(cfg.dbpath, os.listdir(cfg.dbpath + "/pkgs"))
    else:
	displayPkgs(cfg.dbpath, sys.argv[2:])
elif (sys.argv[1] == "update"):
    for pkg in sys.argv[2:]:
	update.doUpdate(cfg.dbpath, cfg.root, pkg)
elif (sys.argv[1] == "commit"):
    if (len(sys.argv) != 6 or sys.argv[3][0] != "/"):
	print "usage: srs commit <pkg> <version> <root> <filelist>"
	sys.exit(1)

    commit.doCommit(cfg.dbpath, sys.argv[2], sys.argv[3], sys.argv[4], sys.argv[5])
else:
    usage()
