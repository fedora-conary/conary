#!/bin/bash

#
# Copyright (c) 2004 Specifix, Inc.
#
# This program is distributed under the terms of the Common Public License,
# version 1.0. A copy of this license should have been distributed with this
# source file in a file called LICENSE. If it is not present, the license
# is always available at http://www.opensource.org/licenses/cpl.php.
#
# This program is distributed in the hope that it will be useful, but
# without any waranty; without even the implied warranty of merchantability
# or fitness for a particular purpose. See the Common Public License for
# full details.
#

if [ $0 = "changemail" ]; then
    CVC=../cvc
else
    CVC=$(echo $0 | sed 's|/[^/]*$||')/../cvc
fi

usage ()
{
    (echo "Usage: changemail --repmap <repmap> --trove <trove> --version <version> "
     echo "                  --email <email> [--email <email>...]"
     echo "       changemail --repmap <repmap> <trove> <version> <email(s)>"
     echo "(using command $CVC)"
    ) 1>&2
    exit 1
}

if [ $# -eq 0 ] ; then
    usage
fi

while [ $# -gt 0 ] ; do
    case $1 in
	--repmap)
	    shift
	    repMapArg="--config"
	    repMap="repositorymap $1"
	    shift
	    ;;
	--trove)
	    shift
	    trove=$1
	    shift
	    ;;
	--email)
	    shift
	    email="$email $1"
	    shift
	    ;;
	--version)
	    shift
	    version=$1
	    shift
	    ;;
	--build-label)
	    shift
 	    buildlabel="--build-label $1"
	    shift
	    ;;
	*)
	    if [ -z "$trove" ] ; then
		trove=$1
	    elif [ -z "$version" ] ; then
		version=$1
	    else
		email="$email $1"
	    fi
	    shift
	    ;;
    esac
done

TMP=$(mktemp /tmp/changemail.XXXXXX) || exit 1


if [ $(echo -n $trove | tail -c7) == ":source" ]; then
    $CVC rdiff $repMapArg "$repMap" $buildlabel $trove -1 $version > $TMP
elif ! echo $trove | grep -s : > /dev/null; then
    echo "${trove} ($version) has been built into the repository" > $TMP
fi

if [ -s $TMP ] ; then
    for address in $email; do
        mail -s "$trove $version" $address < $TMP
    done
fi

rm -f $TMP
