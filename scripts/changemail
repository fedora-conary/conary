#!/bin/bash

#
# Copyright (c) 2004 Specifix, Inc.
#
# This program is distributed under the terms of the Common Public License,
# version 1.0. A copy of this license should have been distributed with this
# source file in a file called LICENSE. If it is not present, the license
# is always available at http://www.opensource.org/licenses/cpl.php.
#
# This program is distributed in the hope that it will be useful, but
# without any waranty; without even the implied warranty of merchantability
# or fitness for a particular purpose. See the Common Public License for
# full details.
#

echo $* > /tmp/EWT

if [ $0 = "changemail" ]; then
    CONARY=../conary
else
    CONARY=$(echo $0 | sed 's|/[^/]*$||')/../conary
fi

usage ()
{
    (echo "Usage: changemail --repmap <repmap> --trove <trove> --version <version> "
     echo "                 --email <email>"
     echo "       changemail --repmap <repmap> <trove> <version> <email>"
     echo "(using command $CONARY)"
    ) 1>&2
    exit 1
}

if [ $# -eq 0 ] ; then
    usage
fi

while [ $# -gt 0 ] ; do
    case $1 in
	--repmap)
	    shift
	    repMapArg="--config"
	    repMap="repositorymap $1"
	    shift
	    ;;
	--trove)
	    shift
	    trove=$1
	    shift
	    ;;
	--email)
	    shift
	    email=$1
	    shift
	    ;;
	--version)
	    shift
	    version=$1
	    shift
	    ;;
	*)
	    if [ -z "$trove" ] ; then
		trove=$1
	    elif [ -z "$version" ] ; then
		version=$1
	    elif [ -z "$email" ] ; then
		email=$1
	    else
		usage
	    fi
	    shift
	    ;;
    esac
done

$CONARY src rdiff $repMapArg "$repMap" $trove -1 $version | \
	mail -s "$trove $version" $email
