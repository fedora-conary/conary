Rewrite derived package shadow creation code because the previous attempt to support capsules was fragile and frankly a bad idea.
